<!DOCTYPE html>
<html lang="en" data-theme="auto">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Roy â€“ Portfolio Signals & Intraday Dashboard</title>
  <!-- Favicon: inline SVG -->
  <link rel="icon" href='data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 64 64"><rect width="64" height="64" rx="12" fill="%230b1120"/><path d="M10 40 L24 28 L34 36 L54 18" stroke="%2360a5fa" stroke-width="6" fill="none" stroke-linecap="round" stroke-linejoin="round"/></svg>' />
  <style>
    :root{
      --bg:#0b0f17; --panel:#121826; --muted:#8b9bb5; --text:#e6edf7; --green:#22c55e; --red:#ef4444; --yellow:#f59e0b; --blue:#60a5fa; --card:#0f1522; --border:#1f2937;
      --shadow: 0 6px 16px rgba(0,0,0,.25);
    }
    /* Light theme variables */
    :root.light {
      --bg:#f8fafc; --panel:#ffffff; --muted:#5b6b85; --text:#0f172a; --green:#16a34a; --red:#dc2626; --yellow:#d97706; --blue:#2563eb; --card:#f1f5f9; --border:#e2e8f0;
      --shadow: 0 6px 16px rgba(2,6,23,.08);
    }
    *{box-sizing:border-box}
    body{margin:0;background:linear-gradient(180deg,var(--bg),var(--panel));color:var(--text);font:14px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial}
    header{position:sticky;top:0;z-index:5;background:color-mix(in oklab, var(--bg), transparent 20%);backdrop-filter:saturate(140%) blur(6px);border-bottom:1px solid var(--border)}
    .wrap{max-width:1200px;margin:0 auto;padding:14px 18px;display:flex;align-items:center;gap:14px;justify-content:space-between}
    h1{font-size:18px;margin:0}
    .sub{color:var(--muted);font-size:12px}
    .grid{display:grid;grid-template-columns:280px 1fr;gap:16px;margin:16px auto;max-width:1200px;padding:0 18px}
    @media (max-width:980px){.grid{grid-template-columns:1fr}}
    .panel{background:var(--panel);border:1px solid var(--border);border-radius:14px;padding:14px;box-shadow:var(--shadow)}
    .btn{background:var(--card);border:1px solid var(--border);color:var(--text);padding:8px 10px;border-radius:10px;cursor:pointer}
    .btn:hover{border-color:color-mix(in oklab, var(--border), var(--blue) 30%)}
    .btn.primary{background:color-mix(in oklab, var(--card), var(--blue) 10%)}
    .btn.danger{background:color-mix(in oklab, var(--card), var(--red) 10%);border-color:color-mix(in oklab, var(--border), var(--red) 25%)}
    .row{display:flex;gap:8px;flex-wrap:wrap}
    .note{color:var(--muted);font-size:12px}
    table{width:100%;border-collapse:separate;border-spacing:0}
    thead th{position:sticky;top:0;background:var(--panel);border-bottom:1px solid var(--border);font-weight:600;padding:8px 6px;text-align:left;font-size:12px;color:color-mix(in oklab, var(--muted), var(--text) 25%)}
    tbody td{padding:8px 6px;border-bottom:1px dashed color-mix(in oklab, var(--border), transparent 40%);vertical-align:middle}
    tbody tr{transition:background .15s ease}
    tbody tr:hover{background:color-mix(in oklab, var(--panel), var(--card) 26%)}
    td input{width:100%;background:var(--card);border:1px solid var(--border);color:var(--text);padding:6px 8px;border-radius:8px}
    td[data-out] {font-variant-numeric:tabular-nums}
    .pill{display:inline-block;padding:4px 8px;border-radius:999px;font-size:12px;border:1px solid var(--border)}
    .pill.green{background:color-mix(in oklab, var(--green), transparent 88%);color:color-mix(in oklab, var(--green), white 20%);border-color:color-mix(in oklab, var(--green), transparent 65%)}
    .pill.red{background:color-mix(in oklab, var(--red), transparent 88%);color:color-mix(in oklab, var(--red), white 20%);border-color:color-mix(in oklab, var(--red), transparent 65%)}
    .pill.yellow{background:color-mix(in oklab, var(--yellow), transparent 88%);color:color-mix(in oklab, var(--yellow), white 20%);border-color:color-mix(in oklab, var(--yellow), transparent 65%)}
    .pill.blue{background:color-mix(in oklab, var(--blue), transparent 88%);color:color-mix(in oklab, var(--blue), white 20%);border-color:color-mix(in oklab, var(--blue), transparent 65%)}
    .kbd{font-family:ui-monospace,SFMono-Regular,Menlo,monospace;font-size:12px;background:var(--card);border:1px solid var(--border);padding:2px 6px;border-radius:6px;color:color-mix(in oklab, var(--text), var(--muted) 25%)}
    .footer{color:var(--muted);font-size:12px;margin-top:6px}
    .theme {display:flex;align-items:center;gap:8px}
    .spark{width:120px;height:32px;display:block}
  </style>
</head>
<body>
  <header>
    <div class="wrap">
      <div>
        <h1>Portfolio Signals & Intraday Dashboard</h1>
        <div class="sub">Type or import your latest prices; the dashboard computes intraday, trend, and discipline metrics automatically. Data saves to your browser.</div>
      </div>
      <div class="theme">
        <button class="btn" id="themeToggle" title="Toggle theme">ðŸŒ“ Theme</button>
      </div>
    </div>
  </header>

  <div class="grid">
    <aside class="panel">
      <h3 style="margin:6px 0 10px">Controls</h3>
      <div class="row" style="margin-bottom:8px">
        <button class="btn" id="addRow">+ Add Row</button>
        <button class="btn" id="save">Save</button>
        <button class="btn" id="load">Load</button>
        <button class="btn danger" id="reset">Reset</button>
      </div>
      <div class="row" style="margin-bottom:8px">
        <label class="btn" for="csvIn">Import CSV</label>
        <input type="file" id="csvIn" accept=".csv" style="display:none" />
        <button class="btn" id="export">Export CSV</button>
      </div>
      <details open>
        <summary style="cursor:pointer;margin:8px 0 6px">Columns (Inputs â†’ Outputs)</summary>
        <ul class="note" style="margin:6px 0 0 16px;line-height:1.35">
          <li><b>Ticker</b> (e.g., SMH)</li>
          <li><b>Last</b>, <b>Open</b>, <b>Prev Close</b></li>
          <li><b>MA20</b>, <b>MA50</b>, <b>MA200</b> (paste from your Signals/Data tabs)</li>
          <li><b>Volume</b>, <b>Avg Vol (3m)</b> â†’ dashboard computes <b>Vol Ratio</b></li>
          <li><b>Entry</b>, <b>Target</b>, <b>Stop</b> â†’ dashboard computes RR & distances</li>
          <li><b>Sparkline Prices</b> â€” optional comma-separated closes for the mini chart (e.g., <span class="kbd">300,304,302,307,310</span>).</li>
        </ul>
      </details>
      <div class="footer">Tip: keep your Google Sheet or brokerage page open to copy numbers. Use <span class="kbd">Save</span> to persist locally.</div>
    </aside>

    <main class="panel">
      <div class="row" style="justify-content:space-between;align-items:center;margin-bottom:8px">
        <div class="note">Edit any input; outputs update instantly. Use the sparkline to visualize recent drift.</div>
        <div class="row">
          <button class="btn" id="sortSignal">Sort by Trend Signal</button>
          <button class="btn" id="sortTicker">Sort by Ticker</button>
        </div>
      </div>
      <div style="overflow:auto;border-radius:12px;border:1px solid var(--border)">
        <table id="tbl">
          <thead>
            <tr>
              <th>Ticker</th>
              <th title="Last Price">Last</th>
              <th>Open</th>
              <th>Prev Close</th>

              <th>% vs Open</th>
              <th>Intraday Dir (Open)</th>
              <th>% vs Prev</th>
              <th>Dir (Prev Close)</th>

              <th>MA20</th>
              <th>MA50</th>
              <th>MA200</th>

              <th>Volume</th>
              <th>Avg Vol (3m)</th>
              <th>Vol Ratio</th>

              <th>Entry</th>
              <th>Target</th>
              <th>Stop</th>

              <th>% From Entry</th>
              <th>% To Target</th>
              <th>% To Stop</th>

              <th>Trend Status</th>
              <th>Trend Signal</th>
              <th>Sparkline Prices</th>
              <th>Mini Chart</th>
              <th></th>
            </tr>
          </thead>
          <tbody id="body"></tbody>
        </table>
      </div>
    </main>
  </div>

  <script>
    /* ===== Theme ===== */
    const root = document.documentElement;
    const savedTheme = localStorage.getItem('roy-theme');
    const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
    function applyTheme(mode){
      // mode: 'light' | 'dark' | 'auto'
      root.classList.remove('light');
      if(mode==='light'){ root.classList.add('light'); }
      localStorage.setItem('roy-theme', mode);
    }
    applyTheme(savedTheme || (prefersDark? 'dark':'light'));
    document.getElementById('themeToggle').onclick=()=>{
      const cur = localStorage.getItem('roy-theme') || (prefersDark? 'dark':'light');
      applyTheme(cur==='light' ? 'dark' : 'light');
    };

    /* ===== Utility ===== */
    const sel = (q,ctx=document)=>ctx.querySelector(q);
    const el = (t,props={})=>Object.assign(document.createElement(t),props);
    const num = (v)=>{
      if(v===undefined||v===null) return NaN;
      if(typeof v==='number') return v;
      const s = (''+v).replace(/[,\s%]/g,'');
      const n = parseFloat(s);
      return isNaN(n)?NaN:n;
    };
    const pct = (v)=> isFinite(v)? (v*100).toFixed(2)+'%':'';
    const fmt = (v)=> isFinite(v)? Number(v).toFixed(2):'';

    const FLAT_BAND = 0.001; // Â±0.10%
    const VOL_PLUS = 1.10;   // â‰¥ 1.10x avg volume

    const DEFAULT_ROWS = [
    const DEFAULT_ROWS = [
  {
    ticker:'SMH',
    last:'295.65', open:'', prev:'',
    ma20:'291.60', ma50:'280.80', ma200:'',
    vol:'', volavg:'',
    entry:'287.26', target:'350.00', stop:'286.22',
    spark:''
  },
  {
    ticker:'XLK',
    last:'265.70', open:'', prev:'',
    ma20:'263.26', ma50:'254.82', ma200:'',
    vol:'', volavg:'',
    entry:'231.87', target:'320.00', stop:'255.89',
    spark:''
  },
  {
    ticker:'SMHX',
    last:'35.50', open:'', prev:'',
    ma20:'34.36', ma50:'32.09', ma200:'',
    vol:'', volavg:'',
    entry:'36.00', target:'45.00', stop:'34.42',
    spark:''
  }
];

    ];

    let rows = JSON.parse(localStorage.getItem('roy-dashboard-v2')||'null') || DEFAULT_ROWS;

    function compute(r){
      const last=num(r.last), open=num(r.open), prev=num(r.prev);
      const ma20=num(r.ma20), ma50=num(r.ma50), ma200=num(r.ma200);
      const vol=num(r.vol), volavg=num(r.volavg);
      const entry=num(r.entry), target=num(r.target), stop=num(r.stop);

      const pOpen = (isFinite(last)&&isFinite(open)&&open!==0)? (last-open)/open : NaN;
      const dirOpen = isFinite(pOpen)? (Math.abs(pOpen)<FLAT_BAND? 'Flat (Â±0.10%)' : (pOpen>0?'Up â‰¥ Open':'Down < Open')):'';

      const pPrev = (isFinite(last)&&isFinite(prev)&&prev!==0)? (last-prev)/prev : NaN;
      const dirPrev = isFinite(pPrev)? (Math.abs(pPrev)<FLAT_BAND? 'Flat (Â±0.10%)' : (pPrev>0?'Up vs Prev Close':'Down vs Prev Close')):'';

      const vRatio = (isFinite(vol)&&isFinite(volavg)&&volavg!==0)? vol/volavg : NaN;

      // MA alignment
      let status = '';
      if (isFinite(ma20)&&isFinite(ma50)&&isFinite(ma200)){
        if (ma20>ma50 && ma50>ma200) status='Bullish (20>50>200)';
        else if (ma20<ma50 && ma50<ma200) status='Bearish (20<50<200)';
        else status='Caution (mixed)';
      }

      // Trend signal (with graceful fallbacks)
      let tSignal = '';
      const volStrong = isFinite(vRatio) && vRatio>=VOL_PLUS;
      if (status){
        if (status.startsWith('Bullish')) tSignal = volStrong? 'Strong Buy (uptrend + vol)':'Buy (uptrend)';
        else if (status.startsWith('Bearish')) tSignal = volStrong? 'Sell (downtrend + vol)':'Sell (downtrend)';
        else tSignal = 'Watch (mixed)';
      } else if (isFinite(last) && isFinite(ma200)) {
        // Fallback: price vs 200
        if (last>ma200) tSignal = volStrong? 'Bullish (above 200 + vol)':'Bullish (above 200)';
        else tSignal = volStrong? 'Bearish (below 200 + vol)':'Bearish/Neutral (below 200)';
      }

      const pFromEntry = (isFinite(last)&&isFinite(entry)&&entry!==0)? (last-entry)/entry : NaN;
      const pToTarget  = (isFinite(last)&&isFinite(target)&&target!==0)? (target-last)/last : NaN;
      const pToStop    = (isFinite(last)&&isFinite(stop)&&stop!==0)? (stop-last)/last : NaN;

      return {pOpen,dirOpen,pPrev,dirPrev,vRatio,status,tSignal,pFromEntry,pToTarget,pToStop};
    }

    function badge(text){
      if(!text) return '';
      const span = el('span',{className:'pill',textContent:text});
      if(/Strong Buy|Buy|Bullish/.test(text)) span.classList.add('green');
      else if(/Sell|Bearish/.test(text)) span.classList.add('red');
      else if(/Watch|Caution/.test(text)) span.classList.add('yellow');
      else span.classList.add('blue');
      return span.outerHTML;
    }

    // Draw sparkline from comma-separated prices
    function sparkSVG(series){
      if(!series || series.length<2) return '';
      const w=120,h=32,pad=2;
      const min=Math.min(...series), max=Math.max(...series);
      const span=max-min || 1;
      const step=(w-2*pad)/(series.length-1);
      const y=(v)=> h-pad - ((v-min)/span)*(h-2*pad);
      const x=(i)=> pad + i*step;
      let d='M '+x(0).toFixed(1)+' '+y(series[0]).toFixed(1);
      for(let i=1;i<series.length;i++){ d+=' L '+x(i).toFixed(1)+' '+y(series[i]).toFixed(1); }
      return `<svg class="spark" viewBox="0 0 ${w} ${h}" xmlns="http://www.w3.org/2000/svg">
        <polyline fill="none" stroke="currentColor" stroke-width="2" points="${series.map((v,i)=>`${x(i).toFixed(1)},${y(v).toFixed(1)}`).join(' ')}" />
      </svg>`;
    }

    const COLS = [
      {key:'ticker', label:'Ticker', in:true},
      {key:'last', label:'Last', in:true},
      {key:'open', label:'Open', in:true},
      {key:'prev', label:'Prev Close', in:true},
      {key:'pOpen', label:'% vs Open', out:true},
      {key:'dirOpen', label:'Intraday Dir (Open)', out:true},
      {key:'pPrev', label:'% vs Prev', out:true},
      {key:'dirPrev', label:'Dir (Prev Close)', out:true},
      {key:'ma20', label:'MA20', in:true},
      {key:'ma50', label:'MA50', in:true},
      {key:'ma200', label:'MA200', in:true},
      {key:'vol', label:'Volume', in:true},
      {key:'volavg', label:'Avg Vol (3m)', in:true},
      {key:'vRatio', label:'Vol Ratio', out:true},
      {key:'entry', label:'Entry', in:true},
      {key:'target', label:'Target', in:true},
      {key:'stop', label:'Stop', in:true},
      {key:'pFromEntry', label:'% From Entry', out:true},
      {key:'pToTarget', label:'% To Target', out:true},
      {key:'pToStop', label:'% To Stop', out:true},
      {key:'status', label:'Trend Status', out:true},
      {key:'tSignal', label:'Trend Signal', out:true, badge:true},
      {key:'spark', label:'Sparkline Prices', in:true},
      {key:'sparkOut', label:'Mini Chart', out:true},
      {key:'del', label:'', out:true}
    ];

    function parseSpark(s){ try{ return (s||'').split(/[\\s,]+/).map(Number).filter(n=>isFinite(n)); }catch{ return []; } }

    function computeRow(r){
      const c = compute(r);
      const series = parseSpark(r.spark);
      return {...c, series};
    }

    function render(){
      const tbody = sel('#body');
      tbody.innerHTML='';
      rows.forEach((r,idx)=>{
        const c = computeRow(r);
        const tr = el('tr');
        COLS.forEach(col=>{
          const td = el('td');
          if(col.in){
            const inp = el('input',{value:r[col.key]??''});
            inp.addEventListener('input',()=>{ r[col.key]=inp.value; render(); });
            if(col.key==='ticker') inp.placeholder='e.g., SMH';
            if(col.key==='spark') inp.placeholder='e.g., 300,304,302,307,310';
            td.appendChild(inp);
          }else if(col.out){
            td.setAttribute('data-out','');
            let val='';
            switch(col.key){
              case 'pOpen': val=pct(c.pOpen); break;
              case 'dirOpen': val=c.dirOpen; break;
              case 'pPrev': val=pct(c.pPrev); break;
              case 'dirPrev': val=c.dirPrev; break;
              case 'vRatio': val=isFinite(c.vRatio)? c.vRatio.toFixed(2):''; break;
              case 'pFromEntry': val=pct(c.pFromEntry); break;
              case 'pToTarget': val=pct(c.pToTarget); break;
              case 'pToStop': val=pct(c.pToStop); break;
              case 'status': val=c.status; break;
              case 'tSignal': val=badge(c.tSignal); break;
              case 'sparkOut': val = c.series.length? sparkSVG(c.series): ''; break;
              case 'del': {
                const b = el('button',{className:'btn danger',textContent:'Delete'});
                b.addEventListener('click',()=>{ rows.splice(idx,1); render(); });
                td.appendChild(b); return;
              }
              default: val='';
            }
            td.innerHTML = val;
          }
          tr.appendChild(td);
        });
        tbody.appendChild(tr);
      });
      // Save light auto
      localStorage.setItem('roy-dashboard-v2', JSON.stringify(rows));
    }

    // Actions
    sel('#addRow').onclick=()=>{ rows.push({ticker:'',last:'',open:'',prev:'',ma20:'',ma50:'',ma200:'',vol:'',volavg:'',entry:'',target:'',stop:'',spark:''}); render(); };
    sel('#save').onclick = ()=>{ localStorage.setItem('roy-dashboard-v2', JSON.stringify(rows)); alert('Saved locally.'); };
    sel('#load').onclick = ()=>{ const v = localStorage.getItem('roy-dashboard-v2'); if(v){ rows=JSON.parse(v); render(); } else alert('No saved data found.'); };
    sel('#reset').onclick=()=>{ if(confirm('Reset dashboard to starter tickers?')){ rows = JSON.parse(JSON.stringify(DEFAULT_ROWS)); render(); } };

    // Sorting
    sel('#sortSignal').onclick=()=>{
      const score=(t)=>/Strong Buy/.test(t)?4:/Buy/.test(t)?3:/Watch|Caution/.test(t)?2:/Sell|Bearish/.test(t)?1:0;
      rows.sort((a,b)=> score(computeRow(b).tSignal)-score(computeRow(a).tSignal)); render();
    };
    sel('#sortTicker').onclick=()=>{ rows.sort((a,b)=> (a.ticker||'').localeCompare(b.ticker||'')); render(); };

    // CSV import/export
    sel('#csvIn').addEventListener('change',e=>{
      const file = e.target.files[0]; if(!file) return;
      const reader = new FileReader();
      reader.onload=()=>{
        const text = reader.result; const lines = text.split(/\r?\n/).filter(Boolean);
        const hdr = lines.shift().split(',').map(h=>h.trim().toLowerCase());
        const idx = (name)=> hdr.indexOf(name);
        const mapRow=(cols)=>({
          ticker: cols[idx('ticker')]||'',
          last: cols[idx('last')]||'', open: cols[idx('open')]||'', prev: cols[idx('prev close')]||cols[idx('prev')]||'',
          ma20: cols[idx('ma20')]||'', ma50: cols[idx('ma50')]||'', ma200: cols[idx('ma200')]||'',
          vol: cols[idx('volume')]||'', volavg: cols[idx('avg vol (3m)')]||cols[idx('avgvol')]||'',
          entry: cols[idx('entry')]||'', target: cols[idx('target')]||'', stop: cols[idx('stop')]||'',
          spark: cols[idx('sparkline prices')]||cols[idx('spark')]||''
        });
        rows = lines.map(l=> mapRow(l.split(',')));
        render();
      };
      reader.readAsText(file);
    });

    sel('#export').onclick=()=>{
      const headers = ['Ticker','Last','Open','Prev Close','MA20','MA50','MA200','Volume','Avg Vol (3m)','Entry','Target','Stop','Sparkline Prices'];
      const csv = [headers.join(',')].concat(rows.map(r=>[
        r.ticker,r.last,r.open,r.prev,r.ma20,r.ma50,r.ma200,r.vol,r.volavg,r.entry,r.target,r.stop,r.spark
      ].join(','))).join('\n');
      const blob = new Blob([csv],{type:'text/csv'}); const url = URL.createObjectURL(blob);
      const a = el('a',{href:url,download:'roy_portfolio_dashboard.csv'}); document.body.appendChild(a); a.click(); setTimeout(()=>{URL.revokeObjectURL(url); a.remove();}, 0);
    };

    render();
  </script>
  <script>
// Replace with your actual Worker URL (without `/quote`)
const workerBase = "https://yahoo-proxy.royrosa83.workers.dev";

async function loadYahoo(workerBase, syms=['SMH','XLK','SMHX']){
  const url = `${workerBase}/quote?symbols=${syms.join(',')}`;
  const data = await fetch(url).then(r=>r.json());
  const map = Object.fromEntries(data.map(d => [d.symbol, d]));

  // Assuming you have a `rows` array the dashboard uses
  rows = rows.map(r=>{
    const d = map[r.ticker];
    if(!d) return r;
    return {
      ...r,
      last: d.last ?? r.last,
      open: d.open ?? r.open,
      prev: d.prev ?? r.prev,
      ma20: d.ma20 ? d.ma20.toFixed(2) : r.ma20,
      ma50: d.ma50 ? d.ma50.toFixed(2) : r.ma50,
      ma200: d.ma200 ? d.ma200.toFixed(2) : r.ma200,
      vol: d.vol ?? r.vol,
      volavg: d.volAvg63 ? Math.round(d.volAvg63) : r.volavg
    };
  });

  // Now redraw the dashboard
  render();
}

// Load data on page load
loadYahoo(workerBase, ['SMH','XLK','SMHX']);
</script>
<script>
// ---- Yahoo via Cloudflare Worker ----
const workerBase = "https://yahoo-proxy.royrosa83.workers.dev";  // your worker

async function loadYahoo(base, syms=['SMH','XLK','SMHX']){
  try {
    const url = `${base}/quote?symbols=${syms.join(',')}`;
    const data = await fetch(url, { cache: "no-store" }).then(r=>r.json());
    const map = Object.fromEntries((data||[]).map(d => [d.symbol, d]));
    // rows is the array the dashboard already uses
    rows = rows.map(r=>{
      const d = map[r.ticker];
      if(!d || d.error) return r;
      const f = (x,n=2)=> x==null ? '' : Number(x).toFixed(n);
      return {
        ...r,
        last:   d.last ?? r.last,
        open:   d.open ?? r.open,
        prev:   d.prev ?? r.prev,
        ma20:   d.ma20  != null ? f(d.ma20)  : r.ma20,
        ma50:   d.ma50  != null ? f(d.ma50)  : r.ma50,
        ma200:  d.ma200 != null ? f(d.ma200) : r.ma200,
        vol:    d.vol ?? r.vol,
        volavg: d.volAvg63 != null ? Math.round(d.volAvg63) : r.volavg
      };
    });
    render();
  } catch (e) {
    console.warn("Yahoo load failed:", e);
  }
}

// Fetch once on page load:
loadYahoo(workerBase, ['SMH','XLK','SMHX']);
</script>

</body>
</html>
