<!doctype html>
<html lang="en" data-theme="auto">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Roy â€“ Portfolio Signals & Intraday Dashboard</title>
  <link rel="icon" href='data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 64 64"><rect width="64" height="64" rx="12" fill="%23230b5a"/><path d="M10 40 L24 28 L32 36 L54 18 L54 44 L10 44 Z" stroke="%23a6e3e9" stroke-width="2" fill="none"/></svg>' />

  <style>
    :root{
      --bg:#0b0f17; --panel:#121826; --muted:#8b9bb5; --text:#e6edf7;
      --green:#22c55e; --red:#ef4444; --yellow:#f59e0b; --blue:#60a5fa;
      --card:#0f1522; --border:#1f2937; --shadow:0 6px 16px rgba(0,0,0,.25);
      --col-scale:1.05; --cell-pad:10px; --base-font:14px;
    }
    :root.light { --bg:#f8fafc; --panel:#ffffff; --muted:#5b6b85; --text:#07172a; --green:#16a34a; --red:#dc2626; --yellow:#d97706; --blue:#2563eb; --card:#f1f5f9; --border:#e2e8f0; --shadow:0 6px 16px rgba(0,0,0,.08); }

    *{box-sizing:border-box}
    body{margin:0;background:linear-gradient(180deg,var(--bg),var(--panel));color:var(--text);font:14px/1.5 ui-sans-serif,system-ui,Segoe UI,Roboto,Helvetica Neue,Arial}
    header{position:sticky;top:0;z-index:5;background:color-mix(in oklab,var(--panel),var(--bg) 20%);backdrop-filter:saturate(140%) blur(6px);border-bottom:1px solid var(--border);box-shadow:var(--shadow);}
    .wrap{max-width:1200px;margin:0 auto;padding:14px 18px;display:flex;align-items:center;justify-content:space-between}
    h1{font-size:18px;margin:0}
    .note{color:var(--muted);font-size:12px}
    .btn{background:var(--card);border:1px solid var(--border);color:var(--text);padding:8px 10px;border-radius:10px;cursor:pointer}
    .btn:hover{border-color:color-mix(in oklab, var(--border), var(--blue) 30%)}
    .btn.danger{background:color-mix(in oklab, var(--card), var(--red) 10%);border-color:color-mix(in oklab, var(--border), var(--red) 25%)}

    /* Main panel */
    main{max-width:1300px;margin:18px auto;padding:0 12px}

    /* Table wrapper â€“ compact, no horizontal scrollbar, sticky header/first col */
    .table-wrapper{
      overflow-x:hidden; max-width:100%;
      border-radius:12px; border:1px solid var(--border); padding-bottom:6px;
      background:color-mix(in oklab, var(--panel), var(--card) 8%);
    }
    table{
      width:100%; border-collapse:separate; border-spacing:0;
      table-layout:auto; min-width:0; font-size:calc(var(--base-font)*.92);
    }
    thead th{
      position:sticky; top:0; z-index:4;
      background:var(--panel); border-bottom:1px solid var(--border);
      font-weight:700; padding:8px 10px; text-align:left;
      color:color-mix(in oklab, var(--muted), var(--text) 25%);
      backdrop-filter:saturate(120%) blur(2px);
      box-shadow:0 1px 0 var(--border), 0 2px 6px rgba(0,0,0,.12);
    }
    tbody td{
      padding:8px 10px; border-bottom:1px dashed color-mix(in oklab, var(--border), transparent 40%);
      vertical-align:middle; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;
    }
    tbody tr:nth-child(odd){ background:color-mix(in oklab, var(--panel), var(--card) 6%) }
    tbody tr:hover{ background:color-mix(in oklab, var(--panel), var(--card) 20%) }

    /* Inputs */
    td input{
      width:100%; background:var(--card); border:1px solid var(--border); color:var(--text);
      padding:6px 8px; border-radius:8px; font-size:13px;
    }

    /* Sticky first column (Ticker) */
    .table-wrapper thead th:first-child,
    .table-wrapper tbody td:first-child{
      position:sticky; left:0; z-index:5; background:var(--panel); box-shadow:1px 0 0 var(--border);
    }

    /* Right-align numeric columns by default (except the few text-heavy ones) */
    .table-wrapper td:not(:first-child):not(:nth-child(21)):not(:nth-child(22)),
    .table-wrapper th:not(:first-child):not(:nth-child(21)):not(:nth-child(22)){
      text-align:right;
    }

    /* Let text-heavy columns wrap & be a bit wider */
    .table-wrapper th:nth-child(21),
    .table-wrapper td:nth-child(21),   /* Trend Status */
    .table-wrapper th:nth-child(22),
    .table-wrapper td:nth-child(22) {  /* Trend Signal */
      white-space:normal; text-align:left; min-width:150px;
    }

    /* Keep the small input column (Sparkline Prices) from growing too wide */
    .table-wrapper th:nth-child(23),
    .table-wrapper td:nth-child(23) {  /* Sparkline Prices */
      min-width:120px; max-width:160px;
    }

    /* Keep the far-right Delete action narrow */
    .table-wrapper th:last-child,
    .table-wrapper td:last-child {     /* Delete button */
      width:84px; text-align:center;
    }

    /* Hide the old left control panel entirely (we're data-only) */
    .grid{ grid-template-columns:1fr !important; max-width:100% !important; }
    .grid > aside.panel{ display:none !important; }

    /* Simple round pill for signal */
    .pill{display:inline-flex;align-items:center;justify-content:center;border:1px solid var(--border);border-radius:999px;padding:8px 10px;min-width:90px}
    .pill.green{background:rgba(34,197,94,.12);color:#86efac;border-color:rgba(34,197,94,.35)}
    .pill.yellow{background:rgba(245,158,11,.12);color:#fde68a;border-color:rgba(245,158,11,.35)}
    .pill.red{background:rgba(239,68,68,.12);color:#fca5a5;border-color:rgba(239,68,68,.35)}
  </style>
</head>

<body>
  <header>
    <div class="wrap">
      <h1>Portfolio Signals &amp; Intraday Dashboard</h1>
      <button id="toggleTheme" class="btn">ðŸŒ— Theme</button>
    </div>
  </header>

  <main>
    <div class="table-wrapper">
      <table id="tbl">
        <thead>
          <tr>
            <th>Ticker</th>
            <th>Last</th>
            <th>Open</th>
            <th>Prev Close</th>
            <th>% vs Open</th>
            <th>% vs Prev</th>
            <th>Intraday<br>Dir (Open)</th>
            <th>Dir<br>(Prev Close)</th>
            <th>MA20</th>
            <th>MA50</th>
            <th>MA200</th>
            <th>Volume</th>
            <th>Avg Vol<br>(3m)</th>
            <th>Vol<br>Ratio</th>
            <th>Entry</th>
            <th>Target</th>
            <th>Stop</th>
            <th>% From Entry</th>
            <th>% To Target</th>
            <th>% To Stop</th>
            <th>Trend Status</th>
            <th>Trend Signal</th>
            <th>Sparkline Prices</th>
            <th>Mini Chart</th>
            <th>Delete</th>
          </tr>
        </thead>
        <tbody id="rows"></tbody>
      </table>
    </div>
    <p class="note" style="margin:10px 6px 0">Data via your Cloudflare Worker. Values cache in your browser.</p>
  </main>

  <script>
    /* ------------------------------- CONFIG ------------------------------- */
    const workerBase = 'https://yahoo-proxy.royrosa83.workers.dev';

    /* ----------------------------- UTILITIES ----------------------------- */
    const $ = (q, el=document)=>el.querySelector(q);
    const $$ = (q, el=document)=>Array.from(el.querySelectorAll(q));
    const root = document.documentElement;

    const fmt = n => (n==null || n!==n) ? '' :
      (Math.abs(n)>=1000 ? n.toLocaleString() : (''+n).replace(/(\.\d{2}).*$/, '$1'));

    const num = v => {
      if (v==null) return null;
      const s = (''+v).replace(/[,\s%$]/g,'');
      const n = parseFloat(s);
      return isFinite(n)? n : null;
    };

    const pct = v => (v==null || v!==v) ? '' : (v>0? '+' : '') + (v*100).toFixed(2)+'%';

    const dirLabel = (a,b) => {
      if (a==null||b==null) return '';
      return a>b ? 'Up' : (a<b ? 'Down' : 'Flat');
    };

    /* --------------------------- LOCAL STORAGE --------------------------- */
    const loadState = () => {
      try { return JSON.parse(localStorage.getItem('roy-dashboard')||'{}'); }
      catch { return {}; }
    };
    const saveState = st => localStorage.setItem('roy-dashboard', JSON.stringify(st));

    /* ----------------------------- DATA MODEL ---------------------------- */
    // Starter rows (ticker list); you can change the defaults here
    const initialTickers = ['SMH','XLK','SMHX'];
    const state = Object.assign({
      rows: initialTickers.map(t=>({ticker:t, entry:null, target:null, stop:null, spark:''}))
    }, loadState());

    // Upgrade old state if needed
    if (!state.rows || !Array.isArray(state.rows)) {
      state.rows = initialTickers.map(t=>({ticker:t, entry:null, target:null, stop:null, spark:''}));
    }

    /* ----------------------------- RENDERING ----------------------------- */
    function render(){
      const tbody = $('#rows'); tbody.innerHTML = '';
      state.rows.forEach((r, idx)=>{
        const tr = document.createElement('tr');

        // Ensure placeholders exist
        const q = r.quote||{};
        const last = num(q.last);
        const open = num(q.open);
        const prev = num(q.prevClose);
        const ma20 = num(q.ma20);
        const ma50 = num(q.ma50);
        const ma200= num(q.ma200);
        const vol = num(q.volume);
        const avgvol = num(q.avgvol);

        const pctVsOpen = (last!=null && open!=null) ? (last/open - 1) : null;
        const pctVsPrev = (last!=null && prev!=null) ? (last/prev - 1) : null;
        const intradayDir = dirLabel(last, open);
        const prevDir = dirLabel(last, prev);
        const volRatio = (vol!=null && avgvol) ? (vol/avgvol) : null;

        // Trend status & signal
        let trendStatus = '';
        let signalPill = '';
        if (ma20 && ma50 && ma200){
          const bullish = (ma20>ma50 && ma50>ma200);
          const bearish = (ma20<ma50 && ma50<ma200);
          if (bullish) {
            trendStatus = 'Bullish<br>(20>50>200)';
            signalPill = `<span class="pill green">Strong<br>Buy<br><small>(uptrend + vol)</small></span>`;
          } else if (bearish) {
            trendStatus = 'Bearish<br>(20<50<200)';
            signalPill = `<span class="pill red">Strong<br>Sell</span>`;
          } else {
            trendStatus = 'Mixed';
            signalPill = `<span class="pill yellow">Caution</span>`;
          }
        }

        // Distance metrics
        const entry = num(r.entry);
        const target = num(r.target);
        const stop = num(r.stop);
        const fromEntry = (last!=null && entry)? (last/entry - 1) : null;
        const toTarget  = (last!=null && target)? (target/last - 1) : null;
        const toStop    = (last!=null && stop)?   (stop/last   - 1) : null;

        tr.innerHTML = `
          <td>${r.ticker || ''}</td>
          <td>${fmt(last)}</td>
          <td><input value="${open!=null? fmt(open):''}" readonly></td>
          <td><input value="${prev!=null? fmt(prev):''}" readonly></td>
          <td>${pct(pctVsOpen)}</td>
          <td>${pct(pctVsPrev)}</td>
          <td>${intradayDir||''}</td>
          <td>${prevDir||''}</td>
          <td>${fmt(ma20)}</td>
          <td>${fmt(ma50)}</td>
          <td>${fmt(ma200)}</td>
          <td>${vol!=null? vol.toLocaleString():''}</td>
          <td>${avgvol!=null? avgvol.toLocaleString():''}</td>
          <td>${volRatio!=null? volRatio.toFixed(2):''}</td>
          <td><input data-k="entry" data-i="${idx}" value="${entry??''}" placeholder="e.g., 287"></td>
          <td><input data-k="target" data-i="${idx}" value="${target??''}" placeholder="e.g., 350"></td>
          <td><input data-k="stop" data-i="${idx}" value="${stop??''}" placeholder="e.g., 286"></td>
          <td>${pct(fromEntry)}</td>
          <td>${pct(toTarget)}</td>
          <td>${pct(toStop)}</td>
          <td>${trendStatus}</td>
          <td>${signalPill}</td>
          <td><input data-k="spark" data-i="${idx}" value="${r.spark||''}" placeholder="e.g., 300,304,302"></td>
          <td class="note">â€”</td>
          <td><button class="btn danger" data-del="${idx}">Delete</button></td>
        `;
        tbody.appendChild(tr);
      });

      // Wire inputs
      $$('input[data-k]').forEach(inp=>{
        inp.addEventListener('change', e=>{
          const i = +inp.dataset.i, k = inp.dataset.k;
          state.rows[i][k] = inp.value;
          saveState(state);
          render(); // recompute %s
        });
      });
      $$('button[data-del]').forEach(b=>{
        b.addEventListener('click', e=>{
          const i = +b.dataset.del;
          state.rows.splice(i,1);
          saveState(state);
          render();
        });
      });
    }

    /* ------------------------------ QUOTES ------------------------------- */
    async function loadYahoo(base, symbols){
      if (!symbols.length) return;
      try{
        const url = `${base.replace(/\/$/,'')}/quote?symbols=${encodeURIComponent(symbols.join(','))}`;
        const res = await fetch(url, {headers:{'cache-control':'no-cache'}});
        const data = await res.json(); // [{symbol,last,open,prevClose,ma20,ma50,ma200,volume,avgvol}]
        const map = {};
        (data||[]).forEach(q=> map[(q.symbol||'').toUpperCase()] = q);

        state.rows.forEach(r=>{
          const q = map[(r.ticker||'').toUpperCase()];
          if (!q) return;
          r.quote = {
            last: num(q.last),
            open: num(q.open),
            prevClose: num(q.prevClose),
            ma20: num(q.ma20),
            ma50: num(q.ma50),
            ma200: num(q.ma200),
            volume: num(q.volume),
            avgvol: num(q.avgvol)
          };
        });
        saveState(state);
        render();
      }catch(err){
        console.error('Worker fetch error', err);
      }
    }

    /* ---------------------------- THEME TOGGLE --------------------------- */
    const savedTheme = localStorage.getItem('roy-theme') || 'auto';
    if (savedTheme==='light') root.classList.add('light');
    $('#toggleTheme').addEventListener('click', ()=>{
      root.classList.toggle('light');
      localStorage.setItem('roy-theme', root.classList.contains('light')?'light':'dark');
    });

    /* ------------------------------- BOOT -------------------------------- */
    // Default to compact density & slightly narrower columns
    root.style.setProperty('--col-scale', localStorage.getItem('roy-col-scale')||'1.05');

    // Initial render then fetch
    render();
    loadYahoo(workerBase, state.rows.map(r=>r.ticker).filter(Boolean));

    // Auto-refresh every 15 minutes
    setInterval(()=> {
      loadYahoo(workerBase, state.rows.map(r=>r.ticker).filter(Boolean));
    }, 15 * 60 * 1000);
  </script>
</body>
</html>
